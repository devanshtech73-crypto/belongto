<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA ‚Ä¢ Apple-Style GPT-4.1 Chatbot</title>

    <!-- Apple System Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* ==========================================================
       CHUNK 1 ‚Äî BASE RESET + APPLE MINIMAL THEME
       ========================================================== */

    :root {
        --bg: #f5f5f7;
        --panel: rgba(255,255,255,0.65);
        --panel-border: rgba(0,0,0,0.08);
        --text: #1d1d1f;
        --text-secondary: #6e6e73;
        --blue: #007aff;
        --radius: 18px;
        --shadow: 0 12px 28px rgba(0,0,0,0.08);
        --blur: 22px;

        --bubble-user: #007aff;
        --bubble-user-text: #ffffff;

        --bubble-bot: #e5e5ea;
        --bubble-bot-text: #000000;

        --border: 1px solid rgba(0,0,0,0.06);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
        background: var(--bg);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    /* ==========================================================
       MAIN APP CONTAINER
       ========================================================== */
    .app-container {
        width: min(880px, 100%);
        height: 93vh;
        background: var(--panel);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border-radius: 28px;
        border: var(--border);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* ==========================================================
       HEADER BAR ‚Äî APPLE STYLE
       ========================================================== */
    .app-header {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 26px;
        border-bottom: var(--border);
        background: rgba(255,255,255,0.55);
        backdrop-filter: blur(20px);
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .logo-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fafafa, #ffffff);
        border: 1px solid rgba(0,0,0,0.08);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
    }

    .header-title h1 {
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.4px;
    }

    .header-title p {
        font-size: 12px;
        color: var(--text-secondary);
    }

    #themeToggle {
        border: none;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
    }

    /* ==========================================================
       CHAT SCROLL AREA
       ========================================================== */
    .chat-area {
        flex: 1;
        padding: 22px;
        overflow-y: auto;
        scroll-behavior: smooth;
    }

    .message {
        display: flex;
        margin-bottom: 18px;
        max-width: 80%;
    }

    .message.bot {
        justify-content: flex-start;
    }

    .message.user {
        justify-content: flex-end;
        margin-left: auto;
    }

    .bubble {
        padding: 12px 18px;
        border-radius: var(--radius);
        font-size: 15px;
        line-height: 1.4;
        max-width: 85%;
    }

    .bot .bubble {
        background: var(--bubble-bot);
        color: var(--bubble-bot-text);
        border-bottom-left-radius: 6px;
    }

    .user .bubble {
        background: var(--bubble-user);
        color: var(--bubble-user-text);
        border-bottom-right-radius: 6px;
    }

    .timestamp {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 6px;
    }

    /* ==========================================================
       INPUT PANEL
       ========================================================== */
    .input-section {
        border-top: var(--border);
        padding: 18px 22px;
        background: rgba(255,255,255,0.6);
        backdrop-filter: blur(8px);
    }

    .api-box {
        margin-bottom: 14px;
        display: flex;
        flex-direction: column;
    }

    .api-box label {
        font-size: 12px;
        margin-bottom: 6px;
        color: var(--text-secondary);
    }

    .api-box input {
        padding: 10px 14px;
        border-radius: var(--radius);
        background: rgba(255,255,255,0.85);
        border: var(--border);
        outline: none;
        font-size: 14px;
    }

    .api-hint {
        margin-top: 6px;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .input-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    textarea {
        flex: 1;
        height: 48px;
        resize: none;
        padding: 12px 16px;
        border-radius: var(--radius);
        border: var(--border);
        background: rgba(255,255,255,0.85);
        outline: none;
        font-size: 15px;
    }

    button {
        border: none;
        cursor: pointer;
        border-radius: var(--radius);
        transition: 0.2s ease;
    }

    #sendButton {
        padding: 12px 20px;
        background: var(--blue);
        color: #fff;
        font-weight: 600;
        font-size: 14px;
    }

    #sendButton:active {
        opacity: 0.85;
    }

    #micButton {
        background: #e1e1e7;
        color: #111;
        padding: 10px 14px;
        font-size: 18px;
    }

    #micButton:active {
        opacity: 0.85;
    }

    /* ==========================================================
       END OF CHUNK 1 CSS
       ========================================================== */
    </style>
</head>

<body>

<div class="app-container">

    <header class="app-header">
        <div class="header-left">
            <div class="logo-circle">N</div>
            <div class="header-title">
                <h1>NOVA</h1>
                <p>Apple-style GPT-4.1 assistant</p>
            </div>
        </div>

        <button id="themeToggle">üåô</button>
    </header>

    <main class="chat-area" id="chatArea">
        <div class="message bot">
            <div class="bubble">
                üëã Hello, I'm <strong>NOVA</strong> ‚Äî your sleek Apple-style AI assistant.
            </div>
        </div>
    </main>

    <footer class="input-section">
        <div class="api-box">
            <label for="apiKeyInput">API Key (local only):</label>
            <input id="apiKeyInput" type="password" placeholder="sk-..." autocomplete="off">
            <span class="api-hint">Your key stays on your device.</span>
        </div>

        <div class="input-row">
            <textarea id="userInput" placeholder="Message NOVA‚Ä¶"></textarea>
            <button id="micButton">üé§</button>
            <button id="sendButton">Send</button>
        </div>
    </footer>

</div>

<script>
/* ==========================================================
   CHUNK 1 JS ‚Äî CORE SETUP + API KEY PLACEHOLDER
   ========================================================== */

const OPENAI_API_KEY = "PASTE-YOUR-REAL-KEY-HERE"; // ‚Üê INSERT YOUR REAL KEY

const chatArea = document.getElementById("chatArea");
const sendButton = document.getElementById("sendButton");
const micButton = document.getElementById("micButton");
const userInput = document.getElementById("userInput");
const apiKeyInput = document.getElementById("apiKeyInput");

function appendMessage(role, text) {
    const msg = document.createElement("div");
    msg.className = `message ${role}`;
    msg.innerHTML = `<div class="bubble">${text}</div>`;
    chatArea.appendChild(msg);
    chatArea.scrollTop = chatArea.scrollHeight;
}
    /* ==========================================================
       CHUNK 2 ‚Äî ADVANCED APPLE UI ANIMATIONS + THEMES
       ========================================================== */

    /* ----------------------------------------------------------
       SMOOTH SCROLLING & MOMENTUM
    ---------------------------------------------------------- */
    .chat-area {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }

    /* ----------------------------------------------------------
       MESSAGE ANIMATION: SLIDE + FADE-IN
    ---------------------------------------------------------- */
    .message {
        animation: fadeSlide 0.35s ease;
    }

    @keyframes fadeSlide {
        0% {
            opacity: 0;
            transform: translateY(8px);
        }
        100% {
            opacity: 1;
            transform: translateY(0px);
        }
    }

    /* ----------------------------------------------------------
       BUBBLE APPEAR BOUNCE (subtle iMessage effect)
    ---------------------------------------------------------- */
    .bubble {
        animation: bubbleBounce 0.24s ease;
        transform-origin: bottom center;
    }

    @keyframes bubbleBounce {
        0% {
            transform: scale(0.85);
        }
        60% {
            transform: scale(1.03);
        }
        100% {
            transform: scale(1.00);
        }
    }

    /* ----------------------------------------------------------
       TYPING INDICATOR (three dots)
    ---------------------------------------------------------- */
    .typing-indicator {
        width: 50px;
        height: 22px;
        background: var(--bubble-bot);
        border-radius: var(--radius);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 6px 10px;
        gap: 6px;
        border-bottom-left-radius: 6px;
    }

    .typing-indicator .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #a1a1a6;
        animation: blink 1.4s infinite ease-in-out;
    }

    .typing-indicator .dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator .dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes blink {
        0% { opacity: 0.2; transform: translateY(0px); }
        50% { opacity: 1; transform: translateY(-3px); }
        100% { opacity: 0.2; transform: translateY(0px); }
    }

    /* ----------------------------------------------------------
       LIGHT / DARK MODE TOGGLE TRANSITION
    ---------------------------------------------------------- */
    body,
    .app-container,
    .bubble,
    .input-section,
    .api-box input,
    textarea {
        transition: background 0.3s ease,
                    color 0.3s ease,
                    border-color 0.3s ease,
                    box-shadow 0.3s ease;
    }

    /* ----------------------------------------------------------
       DARK MODE VARIABLES
    ---------------------------------------------------------- */
    body.dark {
        --bg: #1c1c1e;
        --panel: rgba(40,40,44,0.6);
        --panel-border: rgba(255,255,255,0.06);
        --text: #f2f2f7;
        --text-secondary: #8e8e93;

        --bubble-user: #0a84ff;
        --bubble-user-text: #fff;

        --bubble-bot: #3a3a3c;
        --bubble-bot-text: #fff;
    }

    /* APP CONTAINER IN DARK MODE */
    body.dark .app-container {
        background: rgba(40,40,44,0.5);
        box-shadow: 0 12px 28px rgba(0,0,0,0.4);
    }

    /* HEADER DARK MODE */
    body.dark .app-header {
        background: rgba(44,44,46,0.65);
    }

    /* INPUT AREA DARK */
    body.dark .input-section {
        background: rgba(44,44,46,0.65);
    }

    /* INPUT FIELDS IN DARK */
    body.dark textarea,
    body.dark .api-box input {
        background: rgba(60,60,62,0.8);
        border: 1px solid rgba(255,255,255,0.07);
        color: #fff;
    }

    /* BUTTONS APPLE-STYLE PRESSED STATE */
    #sendButton:active {
        transform: scale(0.96);
    }

    #micButton:active {
        transform: scale(0.96);
    }

    /* ----------------------------------------------------------
       CUSTOM SCROLLBAR (Apple smooth style)
    ---------------------------------------------------------- */
    .chat-area::-webkit-scrollbar {
        width: 6px;
    }

    .chat-area::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-area::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.12);
        border-radius: 20px;
    }

    body.dark .chat-area::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.18);
    }

    /* ----------------------------------------------------------
       MESSAGE TIMESTAMPS ‚Äî subtle fade-in
    ---------------------------------------------------------- */
    .timestamp {
        opacity: 0;
        animation: timeFade 0.4s ease 0.2s forwards;
    }

    @keyframes timeFade {
        0% { opacity: 0; transform: translateY(3px); }
        100% { opacity: 1; transform: translateY(0px); }
    }

    /* ----------------------------------------------------------
       BUTTON HOVER (Apple-like subtle glow)
    ---------------------------------------------------------- */
    #sendButton:hover {
        box-shadow: 0 4px 14px rgba(0,122,255,0.35);
    }

    #micButton:hover {
        box-shadow: 0 4px 14px rgba(0,0,0,0.15);
    }

    /* ----------------------------------------------------------
       INPUT FOCUS GLOW
    ---------------------------------------------------------- */
    textarea:focus,
    .api-box input:focus {
        border-color: #007aff;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.25);
    }

    /* ----------------------------------------------------------
       MOBILE RESPONSIVENESS
    ---------------------------------------------------------- */
    @media (max-width: 680px) {
        .app-container {
            border-radius: 0;
            height: 100vh;
        }

        .app-header {
            height: 60px;
            padding: 0 18px;
        }

        .logo-circle {
            width: 36px;
            height: 36px;
            font-size: 17px;
        }

        .header-title h1 {
            font-size: 17px;
        }

        .header-title p {
            font-size: 11px;
        }

        textarea {
            height: 42px;
            font-size: 14px;
        }

        #sendButton {
            padding: 10px 16px;
            font-size: 13px;
        }

        #micButton {
            padding: 8px 12px;
            font-size: 17px;
        }
    }

    /* ==========================================================
       END OF CHUNK 2 CSS
       ========================================================== */
    </style>

<!-- JS continues from previous script tag -->
<script>
/* ==========================================================
   CHUNK 2 JS ‚Äî DARK MODE TOGGLE + TYPING INDICATOR HANDLER
   ========================================================== */

const themeToggle = document.getElementById("themeToggle");

/* ------------------------------
   LIGHT / DARK MODE TOGGLE
------------------------------ */
themeToggle.addEventListener("click", () => {
    const isDark = document.body.classList.toggle("dark");
    themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
});

/* ------------------------------
   SHOW TYPING INDICATOR
------------------------------ */
function showTyping() {
    const typing = document.createElement("div");
    typing.className = "message bot typing-container";
    typing.innerHTML = `
        <div class="typing-indicator">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    `;
    chatArea.appendChild(typing);
    chatArea.scrollTop = chatArea.scrollHeight;
    return typing;
}

/* ------------------------------
   REMOVE TYPING INDICATOR
------------------------------ */
function hideTyping(typingElement) {
    if (typingElement) typingElement.remove();
}
/* ==========================================================
   CHUNK 3 ‚Äî CORE GPT-4.1 CHAT ENGINE + INPUT HANDLING
   ========================================================== */

/* Global locked flag to prevent double-sending */
let isSending = false;

/* ----------------------------------------------
   APPEND USER MESSAGE TO CHAT
---------------------------------------------- */
function appendUserMessage(text) {
    const wrap = document.createElement("div");
    wrap.className = "message user";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    wrap.appendChild(bubble);

    const time = document.createElement("div");
    time.className = "timestamp";
    time.textContent = new Date().toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
    wrap.appendChild(time);

    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
}

/* ----------------------------------------------
   APPEND BOT MESSAGE
---------------------------------------------- */
function appendBotMessage(text) {
    const wrap = document.createElement("div");
    wrap.className = "message bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    wrap.appendChild(bubble);

    const time = document.createElement("div");
    time.className = "timestamp";
    time.textContent = new Date().toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
    wrap.appendChild(time);

    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;
}

/* ==========================================================
   GPT-4.1 REQUEST FUNCTION
   ========================================================== */
async function sendToGPT(prompt) {
    const apiKey = apiKeyInput.value.trim() || OPENAI_API_KEY;

    if (!apiKey || apiKey === "PASTE-YOUR-REAL-KEY-HERE") {
        appendBotMessage("‚ö†Ô∏è No API key set. Please paste your OpenAI key in the box.");
        return "";
    }

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "gpt-4.1",
                messages: [
                    {
                        role: "system",
                        content: "You are NOVA, an elegant Apple-inspired assistant. Replies must be concise, helpful, and polite."
                    },
                    {
                        role: "user",
                        content: prompt
                    }
                ],
                temperature: 0.65
            })
        });

        if (!response.ok) {
            appendBotMessage(`‚ö†Ô∏è API Error: ${response.status}`);
            return "";
        }

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "‚Ä¶";

        return reply;

    } catch (err) {
        appendBotMessage("‚ö†Ô∏è Network error. Check internet.");
        return "";
    }
}

/* ==========================================================
   SEND MESSAGE FLOW
   ========================================================== */
async function handleSend() {
    if (isSending) return;

    const text = userInput.value.trim();
    if (!text) return;

    userInput.value = "";
    userInput.style.height = "48px";
    isSending = true;

    appendUserMessage(text);

    const typingElm = showTyping();

    const reply = await sendToGPT(text);

    hideTyping(typingElm);

    if (reply) appendBotMessage(reply);

    isSending = false;
}

/* ==========================================================
   TEXTAREA AUTO-GROW
   ========================================================== */
userInput.addEventListener("input", () => {
    userInput.style.height = "auto";
    userInput.style.height = Math.min(userInput.scrollHeight, 180) + "px";
});

/* ==========================================================
   SEND BUTTON HANDLER
   ========================================================== */
sendButton.addEventListener("click", handleSend);

/* ==========================================================
   ENTER KEY SEND
   ========================================================== */
userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
    }
});

/* ==========================================================
   MICROPHONE (VOICE INPUT) SETUP
   ========================================================== */
let recognition;
let isListening = false;

try {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
} catch (err) {
    console.warn("SpeechRecognition not supported.");
}

/* ----------------------------------------------------------
   MIC BUTTON ‚Äî START/STOP LISTENING
---------------------------------------------------------- */
micButton.addEventListener("click", () => {
    if (!recognition) {
        appendBotMessage("üé§ Voice input is not supported on this device.");
        return;
    }

    if (isListening) {
        recognition.stop();
        isListening = false;
        micButton.textContent = "üé§";
    } else {
        recognition.start();
        isListening = true;
        micButton.textContent = "üõë";
    }
});

/* ----------------------------------------------------------
   SPEECH ‚Üí TEXT
---------------------------------------------------------- */
if (recognition) {
    recognition.addEventListener("result", (event) => {
        const transcript = event.results[0][0].transcript.trim();
        userInput.value = transcript;
        handleSend();
    });

    recognition.addEventListener("end", () => {
        isListening = false;
        micButton.textContent = "üé§";
    });
}

/* ==========================================================
   AUTO-FOCUS MESSAGE INPUT
   ========================================================== */
window.addEventListener("load", () => {
    userInput.focus();
});

/* ==========================================================
   CHAT CLEANUP UTILITY
   ========================================================== */
function clearChat() {
    chatArea.innerHTML = `
        <div class="message bot">
            <div class="bubble">
                üîÑ Chat cleared. How can I help?
            </div>
        </div>
    `;
}

/* ==========================================================
   ADDITIONAL QUALITY FUNCTIONS
   ========================================================== */

/* Smooth scroll helper */
function smoothScrollDown() {
    chatArea.scrollTo({
        top: chatArea.scrollHeight,
        behavior: "smooth"
    });
}

/* Manual refresh logic (optional UI will be in chunk 4) */
function softRefresh() {
    appendBotMessage("üîÑ Refresh complete.");
}

/* Preload minimal messages (optional) */
function preloadHints() {
    const hints = [
        "üí° Tip: You can say 'explain like I'm 5'",
        "üí° Tip: Voice input works with the mic button",
        "üí° Tip: Shift+Enter makes a new line"
    ];

    hints.forEach((txt, i) => {
        setTimeout(() => {
            appendBotMessage(txt);
        }, 800 + (i * 600));
    });
}

/* Optional call ‚Äî disabled by default */
/// preloadHints();

/* ==========================================================
   END OF CHUNK 3
   ========================================================== */
/* ==========================================================
   CHUNK 4 ‚Äî ADVANCED FEATURES
   STREAMING, TEXT-TO-SPEECH, UI UTILITIES
   ========================================================== */

/* ----------------------------------------------------------
   STREAMING GPT-4.1 RESPONSE (SIMULATED STREAMING)
   ---------------------------------------------------------- */

/*
   True streaming requires server-side code.
   For now, we simulate streaming by typing the response slowly.
*/

async function streamBotReply(text) {
    const container = document.createElement("div");
    container.className = "message bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = "";
    container.appendChild(bubble);

    chatArea.appendChild(container);
    chatArea.scrollTop = chatArea.scrollHeight;

    let index = 0;

    function typeChar() {
        if (index < text.length) {
            bubble.textContent += text[index++];
            chatArea.scrollTop = chatArea.scrollHeight;
            setTimeout(typeChar, 12); // typing speed
        }
    }

    typeChar();
}

/* ----------------------------------------------------------
   GPT REQUEST + STREAMING WRAPPER
   ---------------------------------------------------------- */
async function handleSendStreaming() {
    if (isSending) return;

    const raw = userInput.value.trim();
    if (!raw) return;

    userInput.value = "";
    userInput.style.height = "48px";

    appendUserMessage(raw);

    const typingElm = showTyping();
    isSending = true;

    const reply = await sendToGPT(raw);

    hideTyping(typingElm);

    if (reply) await streamBotReply(reply);

    isSending = false;
}

/* Replace main handler to always use streaming */
sendButton.removeEventListener("click", handleSend);
sendButton.addEventListener("click", handleSendStreaming);

userInput.removeEventListener("keydown", () => {});
userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSendStreaming();
    }
});

/* ----------------------------------------------------------
   TEXT-TO-SPEECH (Apple-like Serena Voice)
   ---------------------------------------------------------- */
let isSpeaking = false;
let synth = window.speechSynthesis;

function speakText(text) {
    if (!synth) return;

    const utter = new SpeechSynthesisUtterance(text);
    utter.pitch = 1;
    utter.rate = 1;
    utter.volume = 1;

    // Choose a clean Apple-like voice
    const voices = synth.getVoices();
    let appleVoice = voices.find(
        v => v.name.includes("Samantha") || v.name.includes("Serena") || v.name.includes("Victoria")
    );

    if (appleVoice) {
        utter.voice = appleVoice;
    }

    synth.cancel();
    synth.speak(utter);
}

/* Add "tap to speak" feature */
chatArea.addEventListener("click", (e) => {
    if (e.target.classList.contains("bubble") && e.target.parentElement.classList.contains("bot")) {
        speakText(e.target.textContent);
    }
});

/* ----------------------------------------------------------
   AUTO DARK MODE BASED ON SYSTEM
   ---------------------------------------------------------- */
function syncSystemTheme() {
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");
    if (prefersDark.matches) {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
    }
}

syncSystemTheme();

/* Auto update on system change */
window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
    if (e.matches) {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
    } else {
        document.body.classList.remove("dark");
        themeToggle.textContent = "üåô";
    }
});

/* ----------------------------------------------------------
   QUICK ACTIONS BAR ‚Äî (Added in next chunk visually)
   ---------------------------------------------------------- */
function quickAsk(text) {
    userInput.value = text;
    handleSendStreaming();
}

/* ----------------------------------------------------------
   CLEAR CHAT + RESET HISTORY
   ---------------------------------------------------------- */
function resetConversation() {
    chatArea.innerHTML = `
        <div class="message bot">
            <div class="bubble">
                ‚ôªÔ∏è Chat reset. How can I help you now?
            </div>
        </div>
    `;
}

/* ----------------------------------------------------------
   "COMPOSING..." MODE (Fake AI thinking)
   ---------------------------------------------------------- */
function showComposing() {
    const msg = document.createElement("div");
    msg.className = "message bot";
    msg.innerHTML = `
        <div class="bubble" style="opacity:0.6;font-style:italic;">
            Thinking‚Ä¶
        </div>
    `;
    chatArea.appendChild(msg);
    chatArea.scrollTop = chatArea.scrollHeight;
    return msg;
}

function hideComposing(msg) {
    if (msg) msg.remove();
}

/* ----------------------------------------------------------
   LONG AUTO-SCROLL FOR HUGE ANSWERS
   ---------------------------------------------------------- */
function slowScrollToBottom() {
    let step = 0;
    const interval = setInterval(() => {
        chatArea.scrollTop += 25;
        step++;
        if (step > 60) clearInterval(interval);
    }, 16);
}

/* ----------------------------------------------------------
   MESSAGE EDITING (User-side)
   ---------------------------------------------------------- */
function enableEditing(bubble) {
    const original = bubble.textContent;
    const input = document.createElement("textarea");
    input.value = original;
    input.style.width = "100%";
    input.style.height = "90px";
    input.style.borderRadius = "12px";
    input.style.padding = "10px";
    input.style.border = "1px solid #ccc";

    const save = document.createElement("button");
    save.textContent = "Save";
    save.style.marginTop = "6px";
    save.style.padding = "6px 14px";
    save.style.borderRadius = "10px";
    save.style.background = "#007aff";
    save.style.color = "#fff";
    save.style.border = "none";

    bubble.replaceWith(input);
    input.insertAdjacentElement("afterend", save);

    save.addEventListener("click", () => {
        const newBubble = document.createElement("div");
        newBubble.className = "bubble";
        newBubble.textContent = input.value;
        save.remove();
        input.replaceWith(newBubble);
    });
}

/* Double-tap to edit own messages */
chatArea.addEventListener("dblclick", (e) => {
    if (e.target.classList.contains("bubble") && e.target.parentElement.classList.contains("user")) {
        enableEditing(e.target);
    }
});

/* ----------------------------------------------------------
   FAVORITES / PINNED MESSAGES
   ---------------------------------------------------------- */
let favorites = [];

function pinMessage(text) {
    favorites.push(text);
    localStorage.setItem("nova_favorites", JSON.stringify(favorites));
}

function loadFavorites() {
    const saved = localStorage.getItem("nova_favorites");
    if (saved) favorites = JSON.parse(saved);
}

loadFavorites();

/* Long-press to pin a message */
chatArea.addEventListener("mousedown", (e) => {
    if (!e.target.classList.contains("bubble")) return;

    let timer = setTimeout(() => {
        pinMessage(e.target.textContent);
        appendBotMessage("‚≠ê Message saved to favorites.");
    }, 600);

    e.target.addEventListener("mouseup", () => clearTimeout(timer));
    e.target.addEventListener("mouseleave", () => clearTimeout(timer));
});

/* ----------------------------------------------------------
   FAVORITE QUICK-INSERT MENU PREP
   ---------------------------------------------------------- */
function insertFavorite(index) {
    const text = favorites[index] || "";
    if (text) {
        userInput.value = text;
        handleSendStreaming();
    }
}

/* ----------------------------------------------------------
   KEYBOARD NAVIGATION
   ---------------------------------------------------------- */
document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key === "l") {
        e.preventDefault();
        resetConversation();
    }

    if (e.ctrlKey && e.key === "k") {
        e.preventDefault();
        userInput.focus();
    }
});

/* ----------------------------------------------------------
   "NOVA IS THINKING‚Ä¶" ENHANCED EFFECT
   ---------------------------------------------------------- */
function showThinkingAnimation() {
    const el = document.createElement("div");
    el.className = "message bot";
    el.innerHTML = `
        <div class="bubble" style="
            font-style:italic;
            opacity:0.7;
            display:flex;
            align-items:center;
            gap:6px;
        ">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
    `;
    chatArea.appendChild(el);
    chatArea.scrollTop = chatArea.scrollHeight;
    return el;
}

function hideThinking(el) {
    if (el) el.remove();
}

/* ----------------------------------------------------------
   NOVA WELCOME SEQUENCE
   ---------------------------------------------------------- */
function startWelcomeAnimation() {
    const lines = [
        "‚ú® Welcome to NOVA.",
        "üí¨ The clean, Apple-style AI assistant.",
        "üîë Paste your API key above to begin.",
        "üåô Try dark mode for a different feeling."
    ];

    let i = 0;

    function next() {
        if (i >= lines.length) return;
        appendBotMessage(lines[i]);
        i++;
        setTimeout(next, 600);
    }

    next();
}

// OPTIONAL: startWelcomeAnimation();

/* ----------------------------------------------------------
   END OF CHUNK 4
   ========================================================== */
/* ==========================================================
   CHUNK 5 ‚Äî UI PANELS, FAVORITES MENU, QUICK ACTIONS,
   EXTRA UTILITIES, ANIMATIONS, INTERACTIONS
   ========================================================== */

/* ----------------------------------------------------------
   QUICK ACTION PANEL (visual UI prep)
   ---------------------------------------------------------- */
const quickPanel = document.createElement("div");
quickPanel.style.position = "absolute";
quickPanel.style.top = "80px";
quickPanel.style.left = "50%";
quickPanel.style.transform = "translateX(-50%)";
quickPanel.style.display = "flex";
quickPanel.style.gap = "10px";
quickPanel.style.padding = "10px";
quickPanel.style.zIndex = "1000";

quickPanel.innerHTML = `
    <button class="quick-btn" data-q="Explain this like I'm 5">ELI5</button>
    <button class="quick-btn" data-q="Summarize this clearly">Summarize</button>
    <button class="quick-btn" data-q="Give me examples">Examples</button>
    <button class="quick-btn" data-q="Rewrite professionally">Rewrite</button>
`;

document.body.appendChild(quickPanel);

/* Quick button styling */
const styleQuick = document.createElement("style");
styleQuick.textContent = `
.quick-btn {
    padding: 8px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,0.6);
    border: 1px solid rgba(0,0,0,0.08);
    font-size: 13px;
    cursor: pointer;
    backdrop-filter: blur(12px);
    transition: 0.2s ease;
}
.quick-btn:hover {
    background: rgba(255,255,255,0.9);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
body.dark .quick-btn {
    background: rgba(60,60,62,0.7);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.08);
}
`;
document.head.appendChild(styleQuick);

/* Quick button triggers */
document.querySelectorAll(".quick-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const text = btn.getAttribute("data-q");
        userInput.value = text;
        handleSendStreaming();
    });
});

/* ----------------------------------------------------------
   FAVORITES MENU UI
   ---------------------------------------------------------- */
const favMenu = document.createElement("div");
favMenu.style.position = "fixed";
favMenu.style.right = "20px";
favMenu.style.bottom = "100px";
favMenu.style.width = "260px";
favMenu.style.maxHeight = "300px";
favMenu.style.overflowY = "auto";
favMenu.style.borderRadius = "20px";
favMenu.style.background = "rgba(255,255,255,0.7)";
favMenu.style.backdropFilter = "blur(14px)";
favMenu.style.border = "1px solid rgba(0,0,0,0.08)";
favMenu.style.boxShadow = "0 10px 30px rgba(0,0,0,0.15)";
favMenu.style.padding = "14px";
favMenu.style.display = "none";
favMenu.style.zIndex = "1200";

favMenu.innerHTML = `<h3 style="font-size:15px;margin-bottom:10px;">‚≠ê Favorites</h3>`;
document.body.appendChild(favMenu);

function refreshFavoritesMenu() {
    favMenu.innerHTML = `<h3 style="font-size:15px;margin-bottom:10px;">‚≠ê Favorites</h3>`;

    if (favorites.length === 0) {
        favMenu.innerHTML += `<p style="font-size:13px;color:#555;">No saved messages yet.</p>`;
        return;
    }

    favorites.forEach((fav, i) => {
        const item = document.createElement("div");
        item.style.padding = "10px";
        item.style.marginBottom = "8px";
        item.style.borderRadius = "14px";
        item.style.background = "rgba(255,255,255,0.9)";
        item.style.border = "1px solid rgba(0,0,0,0.06)";
        item.style.cursor = "pointer";
        item.style.fontSize = "13px";
        item.textContent = fav;
        item.addEventListener("click", () => insertFavorite(i));
        favMenu.appendChild(item);
    });
}

refreshFavoritesMenu();

/* Show/Hide favorite menu on Shift+F */
document.addEventListener("keydown", (e) => {
    if (e.shiftKey && e.key.toLowerCase() === "f") {
        favMenu.style.display = favMenu.style.display === "none" ? "block" : "none";
        refreshFavoritesMenu();
    }
});

/* ----------------------------------------------------------
   ‚ÄúNOVA IS TYPING‚Äù LONG ANIMATION (advanced)
   ---------------------------------------------------------- */
function showLongTypingAnimation() {
    const wrap = document.createElement("div");
    wrap.className = "message bot";

    wrap.innerHTML = `
        <div class="bubble" style="opacity:0.9;">
            <span class="typing-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </span>
        </div>
    `;

    chatArea.appendChild(wrap);
    chatArea.scrollTop = chatArea.scrollHeight;

    return wrap;
}

/* Auto remove after reply */
function removeLongTyping(elm) {
    if (elm) elm.remove();
}

/* ----------------------------------------------------------
   EXPANDABLE BUBBLES (tap to enlarge)
   ---------------------------------------------------------- */
chatArea.addEventListener("click", (e) => {
    if (!e.target.classList.contains("bubble")) return;

    e.target.classList.toggle("expanded-bubble");
});

const expandStyle = document.createElement("style");
expandStyle.textContent = `
.expanded-bubble {
    max-width: 95% !important;
    white-space: pre-wrap;
    padding: 20px !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    transition: 0.25s ease;
}
`;
document.head.appendChild(expandStyle);

/* ----------------------------------------------------------
   AI AUTOCOMPLETE (suggest next words)
   ---------------------------------------------------------- */
function aiAutocomplete(prefix) {
    const suggestions = [
        "based on your previous input...",
        "let me give you an example...",
        "here is a deeper explanation...",
        "let‚Äôs break this down:",
        "this is easier than it seems:"
    ];

    const pick = suggestions[Math.floor(Math.random() * suggestions.length)];
    return prefix + " " + pick;
}

userInput.addEventListener("input", () => {
    if (userInput.value.length > 12 && Math.random() < 0.02) {
        userInput.placeholder = aiAutocomplete("Try asking");
    }
});

/* ----------------------------------------------------------
   ‚ÄúGLOW‚Äù EFFECT ON NEW BOT MESSAGES
   ---------------------------------------------------------- */
const glowStyle = document.createElement("style");
glowStyle.textContent = `
.message.bot .bubble {
    animation: botGlow 0.6s ease;
}
@keyframes botGlow {
    0% { box-shadow: 0 0 0px rgba(0,122,255,0.0); }
    50% { box-shadow: 0 0 12px rgba(0,122,255,0.3); }
    100% { box-shadow: 0 0 0px rgba(0,122,255,0.0); }
}
`;
document.head.appendChild(glowStyle);

/* ----------------------------------------------------------
   LONG MESSAGE AUTO-SMOOTH SCROLL
   ---------------------------------------------------------- */
function boostedScroll() {
    const interval = setInterval(() => {
        chatArea.scrollTop += 12;
        if (chatArea.scrollTop >= chatArea.scrollHeight - chatArea.clientHeight) {
            clearInterval(interval);
        }
    }, 16);
}

/* ----------------------------------------------------------
   AUTO-HELP POPUP ‚Äî shows after long inactivity
   ---------------------------------------------------------- */
let inactivityTimer;

function startInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        appendBotMessage("‚è≥ Still there? Ask me anything!");
    }, 30000);
}

userInput.addEventListener("keypress", startInactivityTimer);
sendButton.addEventListener("click", startInactivityTimer);

/* ----------------------------------------------------------
   SHAKE ANIMATION on invalid action
   ---------------------------------------------------------- */
function shakeInput() {
    userInput.style.animation = "shake 0.3s ease";
    setTimeout(() => userInput.style.animation = "", 300);
}

const shakeStyle = document.createElement("style");
shakeStyle.textContent = `
@keyframes shake {
    0% { transform: translateX(0px); }
    20% { transform: translateX(-4px); }
    40% { transform: translateX(4px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
    100% { transform: translateX(0px); }
}
`;
document.head.appendChild(shakeStyle);

/* ----------------------------------------------------------
   LIGHT HAPTIC FEEDBACK (mobile vibration)
   ---------------------------------------------------------- */
function haptic() {
    if (navigator.vibrate) navigator.vibrate(8);
}

sendButton.addEventListener("click", haptic);
micButton.addEventListener("click", haptic);

/* ----------------------------------------------------------
   AUTO-SAVE DRAFT
   ---------------------------------------------------------- */
function saveDraft() {
    localStorage.setItem("nova_draft", userInput.value);
}

setInterval(saveDraft, 1500);

function loadDraft() {
    const d = localStorage.getItem("nova_draft");
    if (d) userInput.value = d;
}

loadDraft();

/* ----------------------------------------------------------
   END OF CHUNK 5
   FILE STILL OPEN ‚Äî WAITING FOR ‚Äúfinish file‚Äù
   ========================================================== */
/* ==========================================================
   FINAL BLOCK ‚Äî CLOSE ALL SCRIPTS
   ========================================================== */
</script>

</body>
</html>
