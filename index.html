<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML/JS Cloud Microblog</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a modern look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for smoother transitions */
        .post-card {
            transition: all 0.2s ease-in-out;
        }
        .like-button {
            transition: color 0.1s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .like-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <div id="app-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-8">
        <h1 class="text-4xl font-extrabold text-indigo-600 mb-2 text-center">
            Cloud Microblog Feed
        </h1>
        
        <!-- App Info & Auth Status -->
        <p id="auth-status" class="text-center text-sm text-gray-500 mb-6 border-b pb-4">
            Loading authentication...
        </p>

        <!-- Post Creation Form -->
        <form id="post-form" class="mb-8 p-4 bg-indigo-50 rounded-lg shadow-inner">
            <textarea
                id="post-content"
                placeholder="What's on your mind? Post something public (Max 280 chars)..."
                rows="3"
                maxlength="280"
                class="w-full p-3 border border-indigo-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none text-gray-700"
                required
            ></textarea>
            <div class="flex justify-end items-center mt-3">
                <span id="char-count" class="text-sm text-gray-500 mr-4">280 characters left</span>
                <button
                    type="submit"
                    id="post-button"
                    disabled
                    class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition duration-200 disabled:bg-indigo-300 disabled:cursor-not-allowed"
                >
                    Post to Cloud
                </button>
            </div>
        </form>

        <!-- Post Feed -->
        <h2 id="feed-title" class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Recent Posts</h2>
        <div id="posts-container" class="space-y-4">
            <!-- Posts will be rendered here -->
            <div id="loading-spinner" class="text-center p-8">
                <div class="animate-spin inline-block h-8 w-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div>
                <p class="mt-2 text-gray-600">Connecting to the cloud feed...</p>
            </div>
        </div>
        
        <!-- Error Message -->
        <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>

    </div>

    <footer class="mt-8 text-sm text-gray-400 pb-4">
        Cloud data persistence powered by Firebase Firestore.
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // IMPORTANT: Added updateDoc and increment for the Liking feature
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Environment Variables (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-html-social-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Firebase Service Variables ---
        let app;
        let db;
        let auth;
        let userId = null;
        const POSTS_COLLECTION = 'social_posts'; // Name of the collection

        // --- DOM Elements ---
        const postsContainer = document.getElementById('posts-container');
        const postForm = document.getElementById('post-form');
        const postContentInput = document.getElementById('post-content');
        const postButton = document.getElementById('post-button');
        const authStatusElement = document.getElementById('auth-status');
        const errorMessageElement = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const charCountElement = document.getElementById('char-count');

        /**
         * Helper function for exponential backoff retries.
         */
        const retryFetch = async (fn, retries = 5, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Retrying... 
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        };

        /**
         * Converts a Date object into a relative time string (e.g., "5m ago", "Just now").
         */
        function formatRelativeTime(date) {
            if (!(date instanceof Date)) return 'Just now';

            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);

            if (seconds < 60) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 30) return `${days}d ago`;
            if (months < 12) return `${months}mo ago`;
            return `${years}y ago`;
        }

        /**
         * Displays an error message in the UI.
         */
        function displayError(message) {
            errorMessageElement.textContent = `Error: ${message}`;
            errorMessageElement.classList.remove('hidden');
        }

        /**
         * Handles incrementing the like count for a post.
         * @param {string} postId The ID of the document to update.
         */
        async function handleLike(postId) {
            if (!db || !postId) {
                displayError("Database not initialized or Post ID is missing.");
                return;
            }

            const postDocRef = doc(db, `/artifacts/${appId}/public/data/${POSTS_COLLECTION}`, postId);
            
            try {
                // Use Firebase's increment feature for atomic updates
                await retryFetch(() => updateDoc(postDocRef, {
                    likes: increment(1)
                }));
            } catch (e) {
                console.error("Error updating likes: ", e);
                displayError("Failed to register like. Check console for details.");
            }
        }

        /**
         * Renders the list of posts to the DOM.
         * @param {Array<Object>} posts The array of post objects from Firestore.
         */
        function renderPosts(posts) {
            loadingSpinner.classList.add('hidden');
            postsContainer.innerHTML = ''; 

            if (posts.length === 0) {
                postsContainer.innerHTML = `
                    <p class="text-center text-gray-500 p-8 bg-gray-100 rounded-lg">
                        Be the first to post a message!
                    </p>
                `;
                return;
            }

            posts.forEach(post => {
                const timeAgo = formatRelativeTime(post.timestamp); 
                const isCurrentUser = post.authorId === userId;
                const likes = post.likes || 0; // Default likes to 0
                
                const postElement = document.createElement('div');
                postElement.className = "post-card bg-white p-4 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition duration-300";
                
                postElement.innerHTML = `
                    <p class="text-gray-800 text-lg mb-2">${post.content}</p>
                    
                    <div class="text-xs text-gray-500 flex justify-between items-center pt-2 border-t mt-2">
                        <!-- Author Info -->
                        <span class="font-medium text-indigo-500 flex items-center">
                            Author: ${post.authorId.substring(0, 8)}...
                            ${isCurrentUser ? '<span class="ml-2 text-green-500 font-bold">(You)</span>' : ''}
                        </span>

                        <!-- Actions & Time -->
                        <div class="flex items-center space-x-4">
                            <!-- Like Button -->
                            <button class="like-button flex items-center text-red-400 hover:text-red-600 transition duration-150" data-post-id="${post.id}">
                                <!-- Heart Icon (SVG) -->
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1">
                                    <path fill-rule="evenodd" d="M12 20.25c-5.407 0-9.75-4.193-9.75-9.397 0-3.82 2.14-7.086 5.378-8.442l.754-.332.001-.001.001-.001-.001-.001c.11-.054.224-.11.35-.17l.27-.136 1.554-.78a.75.75 0 0 0 .812-.424l.196-.431c.214-.471.49-.915.825-1.328C13.82 17.65 15 16.012 15 14.25c0-1.233-.518-2.342-1.358-3.177L12 10.755l-.898-1.536A3.75 3.75 0 0 0 8.25 14.25c0 1.233.518 2.342 1.358 3.177l-.35.17c-.11.054-.224.11-.35.17l-.27.136-1.554.78a.75.75 0 0 0-.812.425l-.196.43c-1.84-.297-3.7-.449-5.594-.45.003-5.204 4.346-9.397 9.75-9.397Z" clip-rule="evenodd" />
                                </svg>
                                <span class="font-bold">${likes}</span>
                            </button>
                            <!-- Relative Time -->
                            <span class="text-gray-400 font-semibold">${timeAgo}</span>
                        </div>
                    </div>
                `;
                postsContainer.appendChild(postElement);
            });
        }

        /**
         * Sets up the real-time listener for the public post collection.
         */
        function setupRealtimeListener() {
            if (!db || !userId) return; // Wait for initialization

            // Path for public data: /artifacts/{appId}/public/data/social_posts
            const collectionPath = `/artifacts/${appId}/public/data/${POSTS_COLLECTION}`;
            const postsCollection = collection(db, collectionPath);
            
            // Create a query to listen for all posts
            const postsQuery = query(postsCollection);
            
            onSnapshot(postsQuery, (snapshot) => {
                const newPosts = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    newPosts.push({
                        id: doc.id, // Pass document ID for liking
                        content: data.content,
                        authorId: data.authorId,
                        likes: data.likes || 0, // Ensure likes field is handled
                        // Convert Firebase timestamp to JS Date for display
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    });
                });
                
                // Sort in memory by time descending (newest first)
                newPosts.sort((a, b) => b.timestamp - a.timestamp);
                renderPosts(newPosts);
            }, (err) => {
                console.error("Error fetching posts: ", err);
                displayError("Failed to load real-time feed.");
            });
        }

        /**
         * Handles post submission.
         */
        async function handlePostSubmit(e) {
            e.preventDefault();
            const content = postContentInput.value.trim();
            if (!content || !db || !userId) return;

            postButton.disabled = true;
            postButton.textContent = 'Posting...';
            errorMessageElement.classList.add('hidden');

            const collectionPath = `/artifacts/${appId}/public/data/${POSTS_COLLECTION}`;
            const postsCollection = collection(db, collectionPath);

            try {
                await retryFetch(() => addDoc(postsCollection, {
                    content: content,
                    authorId: userId,
                    likes: 0, // Initialize likes count
                    timestamp: serverTimestamp(),
                }));
                
                postContentInput.value = ''; // Clear input on success
                // Reset character count
                charCountElement.textContent = '280 characters left'; 

            } catch (e) {
                console.error("Error adding document: ", e);
                displayError("Failed to submit post. Please try again.");
            } finally {
                postButton.disabled = false;
                postButton.textContent = 'Post to Cloud';
            }
        }

        /**
         * Handles character count display and button state.
         */
        function updateCharCount() {
            const currentLength = postContentInput.value.length;
            const remaining = 280 - currentLength;
            charCountElement.textContent = `${remaining} characters left`;

            if (remaining < 0) {
                charCountElement.classList.add('text-red-500');
                postButton.disabled = true;
            } else if (currentLength === 0) {
                 charCountElement.classList.remove('text-red-500');
                 postButton.disabled = true;
            } else {
                charCountElement.classList.remove('text-red-500');
                postButton.disabled = false;
            }
        }

        /**
         * Initialize Firebase services and handle authentication.
         */
        async function initFirebase() {
            if (!firebaseConfig) {
                displayError("Firebase configuration is missing. Cannot save data.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Initial Authentication
                if (initialAuthToken) {
                    await retryFetch(() => signInWithCustomToken(auth, initialAuthToken));
                } else {
                    await retryFetch(() => signInAnonymously(auth));
                }

                // 2. Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.innerHTML = `
                            Welcome, <span class="font-mono text-xs p-1 bg-gray-100 rounded text-indigo-700">User ID: ${userId}</span> | 
                            App ID: <span class="font-mono text-xs p-1 bg-gray-100 rounded">${appId}</span>
                        `;
                        postButton.disabled = postContentInput.value.trim().length === 0;
                        setupRealtimeListener();
                    } else {
                        userId = null;
                        authStatusElement.textContent = 'Not authenticated. Posting is disabled.';
                        postButton.disabled = true;
                        loadingSpinner.classList.add('hidden');
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                displayError("Failed to connect to the cloud database.");
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            postForm.addEventListener('submit', handlePostSubmit);
            postContentInput.addEventListener('input', updateCharCount);
            updateCharCount(); // Initial check for button state

            // Event delegation for the Like Button
            postsContainer.addEventListener('click', (e) => {
                const likeButton = e.target.closest('.like-button');
                if (likeButton) {
                    const postId = likeButton.dataset.postId;
                    handleLike(postId);
                }
            });
        });
    </script>
</body>
</html>
