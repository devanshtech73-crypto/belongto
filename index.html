import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from 'firebase/firestore';

// Global variables provided by the environment (MUST be used)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-social-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Helper to handle exponential backoff for retries
const retryFetch = async (fn, retries = 5, delay = 1000) => {
    for (let i = 0; i < retries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (i === retries - 1) throw error;
            console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // Exponential backoff
        }
    }
};

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [posts, setPosts] = useState([]);
    const [newPostContent, setNewPostContent] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // 1. Firebase Initialization and Authentication
    useEffect(() => {
        if (!firebaseConfig) {
            setError("Firebase configuration is missing.");
            setIsLoading(false);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const userAuth = getAuth(app);
            
            setDb(firestore);
            setAuth(userAuth);
            
            // Log in using the provided token or anonymously
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await retryFetch(() => signInWithCustomToken(userAuth, initialAuthToken));
                    } else {
                        await retryFetch(() => signInAnonymously(userAuth));
                    }
                } catch (e) {
                    console.error("Firebase sign-in failed:", e);
                    setError("Failed to authenticate with the server.");
                }
            };
            authenticate();

            // Listen for auth state changes
            const unsubscribe = onAuthStateChanged(userAuth, (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    setUserId(null);
                }
                setIsAuthReady(true);
                setIsLoading(false);
            });

            return () => unsubscribe();

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setError("Failed to initialize Firebase services.");
            setIsLoading(false);
        }
    }, []);

    // 2. Real-Time Data Fetching (Posts)
    useEffect(() => {
        // Guard clause: Don't run queries until auth is ready and db is initialized
        if (!isAuthReady || !db || !userId) return;

        // Path for public data: /artifacts/{appId}/public/data/{your_collection_name}
        const collectionPath = `/artifacts/${appId}/public/data/social_posts`;
        const postsCollection = collection(db, collectionPath);
        
        // Create a query to order by timestamp (descending)
        const postsQuery = query(postsCollection);
        
        // Listen for real-time updates
        const unsubscribe = onSnapshot(postsQuery, (snapshot) => {
            const newPosts = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                newPosts.push({
                    id: doc.id,
                    ...data,
                    // Convert Firebase timestamp to JS Date for display
                    timestamp: data.timestamp ? new Date(data.timestamp.toDate()) : 'No Date',
                });
            });

            // Sort in memory by time descending (newest first)
            newPosts.sort((a, b) => b.timestamp - a.timestamp);
            setPosts(newPosts);
            setIsLoading(false);
        }, (err) => {
            console.error("Error fetching posts: ", err);
            setError("Failed to load posts from the database.");
            setIsLoading(false);
        });

        // Cleanup listener on component unmount or dependency change
        return () => unsubscribe();
    }, [isAuthReady, db, userId]); // Dependencies to re-run the effect

    // 3. Post Submission Logic
    const handlePostSubmit = useCallback(async (e) => {
        e.preventDefault();
        if (!newPostContent.trim() || !db || !userId) return;

        const content = newPostContent.trim();
        const collectionPath = `/artifacts/${appId}/public/data/social_posts`;
        const postsCollection = collection(db, collectionPath);

        try {
            await retryFetch(() => addDoc(postsCollection, {
                content: content,
                authorId: userId,
                timestamp: serverTimestamp(),
            }));
            setNewPostContent('');
        } catch (e) {
            console.error("Error adding document: ", e);
            setError("Failed to submit post. Please try again.");
        }
    }, [newPostContent, db, userId]);

    // 4. Render UI
    if (error) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-red-100 p-4">
                <div className="bg-white p-6 rounded-lg shadow-lg max-w-lg text-center">
                    <h2 className="text-xl font-bold text-red-600 mb-4">Application Error</h2>
                    <p className="text-gray-700">{error}</p>
                    <p className="mt-2 text-sm text-gray-500">Check the console for more details.</p>
                </div>
            </div>
        );
    }

    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                <p className="ml-4 text-gray-600">Loading social feed...</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50 font-sans flex flex-col items-center p-4">
            <div className="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-8">
                <h1 className="text-4xl font-extrabold text-blue-600 mb-2 text-center">
                    Microblog Feed
                </h1>
                <p className="text-center text-sm text-gray-500 mb-6 border-b pb-4">
                    Welcome, <span className="font-mono text-xs p-1 bg-gray-100 rounded">User ID: {userId}</span> | 
                    App ID: <span className="font-mono text-xs p-1 bg-gray-100 rounded">{appId}</span>
                </p>

                {/* Post Creation Form */}
                <form onSubmit={handlePostSubmit} className="mb-8 p-4 bg-blue-50 rounded-lg shadow-inner">
                    <textarea
                        value={newPostContent}
                        onChange={(e) => setNewPostContent(e.target.value)}
                        placeholder="What's on your mind? Post something public..."
                        rows="3"
                        className="w-full p-3 border border-blue-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 resize-none text-gray-700"
                        maxLength="280"
                        required
                    />
                    <div className="flex justify-end items-center mt-3">
                        <span className="text-sm text-gray-500 mr-4">{280 - newPostContent.length} characters left</span>
                        <button
                            type="submit"
                            disabled={!newPostContent.trim()}
                            className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-full shadow-md hover:bg-blue-700 transition duration-200 disabled:bg-blue-300 disabled:cursor-not-allowed"
                        >
                            Post
                        </button>
                    </div>
                </form>

                {/* Post Feed */}
                <h2 className="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Recent Posts ({posts.length})</h2>
                {posts.length === 0 ? (
                    <p className="text-center text-gray-500 p-8 bg-gray-100 rounded-lg">
                        Be the first to post a message!
                    </p>
                ) : (
                    <div className="space-y-4">
                        {posts.map((post) => (
                            <div key={post.id} className="bg-white p-4 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition duration-300">
                                <p className="text-gray-800 text-lg mb-2">{post.content}</p>
                                <div className="text-xs text-gray-500 flex justify-between items-center">
                                    <span className="font-medium text-blue-500">
                                        Author: {post.authorId.substring(0, 8)}...
                                        {post.authorId === userId && <span className="ml-2 text-green-500">(You)</span>}
                                    </span>
                                    <span>
                                        {post.timestamp.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
            <footer className="mt-8 text-sm text-gray-400 pb-4">
                Powered by React & Firebase Firestore (Public Collection)
            </footer>
        </div>
    );
};

export default App;
